<?php
session_start();
include('../config/db.php');

if (!isset($_SESSION['user'])) {
    header("Location: ../auth/login.php");
    exit();
}

// ‡∏£‡∏±‡∏ö user id ‡∏à‡∏≤‡∏Å session
$user_id = $_SESSION['user']['id'];

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $answers = [];
    for ($i = 1; $i <= 9; $i++) {
        $key = 'score' . $i;
        if (!isset($_POST[$key])) {
            echo "<script>alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠'); window.history.back();</script>";
            exit();
        }
        $answers[$i] = (int) $_POST[$key];
    }

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°
    $total_score = array_sum($answers);

    // ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á
    if ($total_score >= 0 && $total_score <= 4) {
        $level = "‡∏ô‡πâ‡∏≠‡∏¢‡∏°‡∏≤‡∏Å";
    } elseif ($total_score <= 8) {
        $level = "‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢";
    } elseif ($total_score <= 14) {
        $level = "‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á";
    } elseif ($total_score <= 19) {
        $level = "‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏°‡∏≤‡∏Å";
    } else {
        $level = "‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å";
    }

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    $stmt = $conn->prepare("INSERT INTO evaluations 
        (user_id, q1, q2, q3, q4, q5, q6, q7, q8, q9, total_score, danger_level) 
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)");

    if (!$stmt) {
        die("SQL Prepare Failed: " . $conn->error);
    }
$stmt->bind_param("iiiiiiiiiiis",
    $user_id,
    $answers[1], $answers[2], $answers[3], $answers[4], $answers[5],
    $answers[6], $answers[7], $answers[8], $answers[9],
    $total_score, $level
);


    if ($stmt->execute()) {
        echo "<script>alert('‚úÖ ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); window.location='results.php';</script>";
    } else {
        echo "<script>alert('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " . $stmt->error . "');</script>";
    }
    exit();
}
?>

<!-- ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô -->
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; font-size: 18px; background-color: #f8f9fa; }
        .container { max-width: 900px; margin-top: 40px; background: white; padding: 30px; border-radius: 12px; }
    </style>
</head>
<body>
<div class="container">
    <h4 class="text-center mb-4">üìù ‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï (‡πÇ‡∏£‡∏Ñ‡∏ã‡∏∂‡∏°‡πÄ‡∏®‡∏£‡πâ‡∏≤)</h4>
    <form method="post">
        <?php
        $questions = [
            "1. ‡πÄ‡∏ö‡∏∑‡πà‡∏≠ ‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏≠‡∏¢‡∏≤‡∏Å‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£",
            "2. ‡πÑ‡∏°‡πà‡∏™‡∏ö‡∏≤‡∏¢‡πÉ‡∏à ‡∏ã‡∏∂‡∏°‡πÄ‡∏®‡∏£‡πâ‡∏≤ ‡∏ó‡πâ‡∏≠‡πÅ‡∏ó‡πâ",
            "3. ‡∏´‡∏•‡∏±‡∏ö‡∏¢‡∏≤‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏ö‡πÜ ‡∏ï‡∏∑‡πà‡∏ô‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏Å‡πÑ‡∏õ",
            "4. ‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏á‡πà‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡∏°‡∏µ‡πÅ‡∏£‡∏á",
            "5. ‡πÄ‡∏ö‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏¥‡∏ô‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ",
            "6. ‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏î‡∏µ‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á ‡∏Ñ‡∏¥‡∏î‡∏ß‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡∏ú‡∏¥‡∏î‡∏´‡∏ß‡∏±‡∏á",
            "7. ‡∏™‡∏°‡∏≤‡∏ò‡∏¥‡πÑ‡∏°‡πà‡∏î‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£ ‡πÄ‡∏ä‡πà‡∏ô ‡∏î‡∏π‡∏ó‡∏µ‡∏ß‡∏µ ‡∏ü‡∏±‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏∏ ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏™‡∏°‡∏≤‡∏ò‡∏¥",
            "8. ‡∏û‡∏π‡∏î‡∏ä‡πâ‡∏≤‡∏•‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏™‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡∏™‡πà‡∏≤‡∏¢‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏¥‡πà‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢",
            "9. ‡∏Ñ‡∏¥‡∏î‡∏ó‡∏≥‡∏£‡πâ‡∏≤‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏¥‡∏î‡∏ß‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏¢‡πÑ‡∏õ‡∏Ñ‡∏á‡∏à‡∏∞‡∏î‡∏µ"
        ];

        $choices = [
            0 => "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏¢",
            1 => "‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏≤‡∏á‡∏ß‡∏±‡∏ô",
            2 => "‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ö‡πà‡∏≠‡∏¢",
            3 => "‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô"
        ];

        foreach ($questions as $i => $q) {
            $index = $i + 1;
            echo "<div class='mb-3'><label class='form-label'>$q</label>";
            foreach ($choices as $val => $label) {
                echo "<div class='form-check'>
                        <input class='form-check-input' type='radio' name='score$index' value='$val' required>
                        <label class='form-check-label'>$label</label>
                      </div>";
            }
            echo "</div>";
        }
        ?>
        <div class="text-center mt-4">
            <button type="submit" class="btn btn-success">‚úÖ ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</button>
            <a href="dashboard.php" class="btn btn-secondary">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</a>
        </div>
    </form>
</div>
</body>
</html>
